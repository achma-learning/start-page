<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>Barre de Recherche Dynamique</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/gif" href="https://raw.githubusercontent.com/achma-learning/start-page/main/images/search.gif" />
    <style>
        /* Styles initiaux inchangés */
        body {
            font-family: Arial, sans-serif;
            background: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
        }
        .search-container {
            margin-top: 40px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.09);
            padding: 30px;
            width: 1100px;
            display: flex;
            flex-direction: column;
            gap: 34px;
        }
        .category-row {
            display: flex;
            flex-direction: row;
            gap: 25px;
            justify-content: center;
        }
        .category-section {
            background: #f8f8f8;
            border-radius: 10px;
            padding: 18px 12px 16px 16px;
            min-width: 230px;
            flex: 1 1 0;
            box-shadow: 0 1px 6px rgba(0,0,0,0.04);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .category-title {
            font-weight: bold;
            color: #000;
            margin-bottom: 10px;
            font-style: italic;
            text-decoration: underline;
            font-size: 1.09em;
        }
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .radio-group label {
            white-space: nowrap;
            cursor: pointer;
            padding-left: 2px;
            transition: background 0.19s ease;
            border-radius: 3px;
            font-size: 1em;
        }
        .radio-group input[type=radio] {
            margin-right: 6px;
        }
        .radio-group label.selected,
        .radio-group label:hover {
            background: #e0f0ff;
            font-weight: bold;
        }
        .search-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            width: 100%;
            margin-bottom: 0;
            position: relative;
        }
        #searchInput {
            padding: 10px 14px;
            font-size: 15px;
            border: 1px solid #c4d3fa;
            border-radius: 6px;
            width: 470px;
            box-sizing: border-box;
            background: #f8fafb;
            transition: border-color 0.22s;
        }
        #searchInput:focus { border-color: #8ab6f9; outline: none; }
        button {
            padding: 9px 22px;
            font-size: 15px;
            background: #4285f4;
            color: white;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            transition: background 0.18s;
        }
        button:hover {
            background: #3267d6;
        }
        #wikiToggleBtn {
            background: #cb6d51;
            padding: 9px 16px;
            white-space: nowrap;
        }
        #wikiToggleBtn:hover {
            background: #a55842;
        }
        #searchSource {
            font-size: 13px;
            color: #333;
            margin-top: 10px;
            margin-bottom: 2px;
            min-height: 18px;
            text-align: center;
        }
        #wikiContent {
            background: #f8f8f8;
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 1px 6px rgba(0,0,0,0.1);
            font-size: 13px;
            color: #333;
            max-height: 260px;
            overflow-y: auto;
            margin-top: 8px;
            display: none;
            user-select: text;
        }
        #wikiContent ul {
            margin: 0 0 12px 18px;
            padding: 0;
        }
        #wikiContent li {
            margin-bottom: 4px;
            line-height: 1.3;
        }
        #wikiContent b {
            color: #1e48be;
            font-weight: 600;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            font-size: 13px;
            margin-bottom: 12px;
            user-select: none;
            gap: 6px;
            color: #333;
        }
        /* Nouveau style pour bouton filetypes */
        #filetypesBtn {
            background: #4caf50;
            padding: 9px 16px;
            white-space: nowrap;
            color: white;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            transition: background 0.18s;
        }
        #filetypesBtn:hover {
            background: #3a9d3a;
        }
        /* Popup filetypes similaire au wikiContent mais décalé */
        #filetypesPopup {
            position: absolute;
            top: 42px; /* un peu sous la barre de boutons */
            right: 100px; /* à gauche du bouton filetypes */
            width: 440px;          /* agrandi */
            max-height: 450px;     /* agrandi */
            overflow-y: auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.25);
            padding: 1.5rem;       /* plus d'espace */
            font-size: 1rem;       /* texte un peu plus grand */
            color: #333;
            display: none;
            opacity: 1;
            transition: opacity 0.8s ease;
            z-index: 1100;
            user-select: none;
        }
        #filetypesPopup h3 {
            margin-top: 0;
            font-size: 1.1rem;
            border-bottom: 1px solid #ccc;
            padding-bottom: 0.3rem;
            user-select: text;
        }
        #filetypesPopup ul {
            list-style-type: none;
            padding-left: 0;
            margin: 0;
        }
        #filetypesPopup li.category {
            font-weight: bold;
            margin-top: 0.8rem;
            cursor: default;
            user-select: text;
        }
        #filetypesPopup li.item {
            cursor: pointer;
            padding: 0.6rem 0.4rem; /* agrandi la zone cliquable */
            font-size: 1rem;       /* plus grande lisibilité */
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s ease;
            user-select: text;     /* permet la sélection */
        }
        #filetypesPopup li.item:hover {
            background-color: #e0f0ff;
        }
        @media (max-width: 1090px) {
          /* Ajustement popup en responsive */
          #filetypesPopup {
            right: 5px;
            width: 95vw;          /* élargit pour petits écrans */
            max-height: 350px;
            top: 60px;
          }
        }
    </style>
</head>
<body>
  <div class="search-container">
    <div class="category-row">
      <div class="category-section">
        <div class="category-title">Group1: General Search</div>
        <div class="radio-group" id="group1">
          <label><input type="radio" name="searchEngine" value="g:" checked>Google</label>
          <label><input type="radio" name="searchEngine" value="yt:">YouTube</label>
          <label><input type="radio" name="searchEngine" value="brave:">Brave Search</label>
          <label><input type="radio" name="searchEngine" value="ddg:">DuckDuckGo</label>
          <label><input type="radio" name="searchEngine" value="yadx:">Yandex</label>
          <label><input type="radio" name="searchEngine" value="bing:">Bing</label>
          <label><input type="radio" name="searchEngine" value="g100:">Google 100 results</label>
          <label><input type="radio" name="searchEngine" value="g+:">Google Advanced</label>
        </div>
      </div>
      <div class="category-section">
        <div class="category-title">Group2: Academic/Thesis</div>
        <div class="radio-group" id="group2">
           <label><input type="radio" name="searchEngine" value="gs:">Google Scholar</label>
          <label><input type="radio" name="searchEngine" value="these2.0:">These2.0</label>
          <label><input type="radio" name="searchEngine" value="cismef-th:">CISMeF Thèses</label>
          <label><input type="radio" name="searchEngine" value="these-ma:">Toubkal</label>
          <label><input type="radio" name="searchEngine" value="these-ma-gs:">Toubkal - Google Search</label>
          <label><input type="radio" name="searchEngine" value="these-fr:">Theses.fr</label>
          <label><input type="radio" name="searchEngine" value="rgt:">ResearchGate</label>
          <label><input type="radio" name="searchEngine" value="ndltd:">NDLTD</label>
        </div>
      </div>
      <div class="category-section">
        <div class="category-title">Group3: Medical/Health</div>
        <div class="radio-group" id="group3">
          <label><input type="radio" name="searchEngine" value="pbmd:">PubMed</label>
          <label><input type="radio" name="searchEngine" value="cismef:">CISMeF</label>
          <label><input type="radio" name="searchEngine" value="cismef-edn:">CISMeF EDN</label>
          <label><input type="radio" name="searchEngine" value="cismef-bp:">CISMeF Best Practices</label>
          <label><input type="radio" name="searchEngine" value="cismef-edu:">CISMeF Education</label>
          <label><input type="radio" name="searchEngine" value="lissa:">LISSA</label>
          <label><input type="radio" name="searchEngine" value="hetop:">HETOP</label>
          <label><input type="radio" name="searchEngine" value="has:">Haute Autorité de Santé</label>
          <label><input type="radio" name="searchEngine" value="openmd:">OpenMD</label>
        </div>
      </div>
      <div class="category-section">
        <div class="category-title">Group4: AI/Advanced</div>
        <div class="radio-group" id="group4">
          <label><input type="radio" name="searchEngine" value="wolfram:">Wolfram Alpha</label>
          <label><input type="radio" name="searchEngine" value="gpt:">ChatGPT</label>
          <label><input type="radio" name="searchEngine" value="x.ai:">Grok</label>
          <label><input type="radio" name="searchEngine" value="g.ai:">Gemini</label>
          <label><input type="radio" name="searchEngine" value="p.ai:">Perplexity</label>
        </div>
      </div>
    </div>
    <div class="search-bar">
      <form id="searchForm" style="display:flex; align-items:center; gap:6px; width: 100%; justify-content: center;">
        <input type="text" id="searchInput" autocomplete="off" placeholder="Apprendre est un chemin qui nous permet d’oublier nos soucis, tout en nous rendant compétents et humbles devant l’œuvre magnifique de la Création divine" />
        <button type="submit">Rechercher</button>
        <button type="button" id="wikiToggleBtn" aria-expanded="false" aria-controls="wikiContent">Wiki</button>
        <!-- Nouveau bouton filetypes -->
        <button type="button" id="filetypesBtn" aria-expanded="false" aria-controls="filetypesPopup" aria-haspopup="true">filetypes:</button>
        <label for="siteCheckbox" style="font-size: 13px; margin-left: 8px; cursor: pointer; user-select: none;">
          <input type="checkbox" id="siteCheckbox" style="margin-right: 4px; vertical-align: middle;">
          site
        </label>
      </form>
    </div>
    <div id="searchSource" aria-live="polite" role="status">Entrez une requête pour afficher la source</div>
    <div id="wikiContent" role="region" aria-label="Wiki des préfixes et moteurs" tabindex="0" >
      <div class="checkbox-container">
        <input type="checkbox" id="keepWikiOpenCheckbox" />
        <label for="keepWikiOpenCheckbox">Keep wiki open</label>
      </div>
      <ul>
        <li><b>g:</b> Google</li>
        <li><b>yt:</b> YouTube</li>
        <li><b>brave:</b> Brave Search</li>
        <li><b>ddg:</b> DuckDuckGo</li>
        <li><b>yadx:</b> Yandex</li>
        <li><b>bing:</b> Bing</li>
        <li><b>g100:</b> Google 100 results</li>
        <li><b>g+:</b> Google Advanced</li>
      </ul>
      <ul>
        <li><b>these-fr:</b> Theses.fr</li>
        <li><b>these2.0:</b> These2.0</li>
        <li><b>these-ma:</b> Toubkal</li>
        <li><b>these-ma-gs:</b> Toubkal Google Search</li>
        <li><b>cismef-th:</b> CISMeF Thèses</li>
        <li><b>gs:</b> Google Scholar</li>
        <li><b>rgt:</b> ResearchGate</li>
        <li><b>ndltd:</b> NDLTD</li>
      </ul>
      <ul>
        <li><b>pbmd:</b> PubMed</li>
        <li><b>cismef:</b> CISMeF</li>
        <li><b>cismef-edn:</b> CISMeF EDN</li>
        <li><b>cismef-bp:</b> CISMeF Best Practices</li>
        <li><b>cismef-edu:</b> CISMeF Education</li>
        <li><b>lissa:</b> LISSA</li>
        <li><b>hetop:</b> HETOP</li>
        <li><b>has:</b> Haute Autorité de Santé</li>
        <li><b>openmd:</b> OpenMD</li>
      </ul>
      <ul>
        <li><b>wolfram:</b> Wolfram Alpha</li>
        <li><b>gpt:</b> ChatGPT</li>
        <li><b>x.ai:</b> Grok</li>
        <li><b>g.ai:</b> Gemini</li>
        <li><b>p.ai:</b> Perplexity</li>
      </ul>
    </div>
    <!-- Popup filetypes injectée ici -->
    <div id="filetypesPopup" role="dialog" aria-modal="true" aria-labelledby="filetypesTitle" tabindex="-1">
      <h3 id="filetypesTitle">Fichiers indexables par Google</h3>
      <p>Cliquez sur un type de fichier.</p>
      <ul id="filetypeList"></ul>
    </div>
  </div>
<script>
  // Données types de fichiers indexables by Google
  const filetypesWiki = {
    "Documents": [
      {name: "Adobe Portable Document Format", ext: "pdf"},
      {name: "Microsoft Word", ext: "doc"},
      {name: "Microsoft Word-2", ext: "docx"},
      {name: "Rich Text Format", ext: "rtf"},
      {name: "Microsoft PowerPoint", ext: "ppt"},
      {name: "Microsoft PowerPoint-2", ext: "pptx"},
      {name: "Microsoft Excel", ext: "xls"},
      {name: "Microsoft Excel-2", ext: "xlsx"},
      {name: "Comma-Separated Values", ext: "csv"},
      {name: "TeX/LaTeX", ext: "tex"},
      {name: "Electronic Publication", ext: "epub"},
      {name: "OpenOffice text", ext: "odt"},
      {name: "OpenOffice presentation", ext: "odp"},
      {name: "OpenOffice spreadsheet", ext: "ods"},
      {name: "Text", ext: "txt"},
      {name: "Text-2", ext: "text"},
    ],  
          "Images": [
      {name: "BMP", ext: "bmp"},
      {name: "GIF", ext: "gif"},
      {name: "JPEG", ext: "jpeg"},
      {name: "JPG", ext: "jpg"},
      {name: "PNG", ext: "png"},
      {name: "WebP", ext: "webp"},
      {name: "SVG", ext: "svg"},
      {name: "AVIF", ext: "avif"}
    ],
    "Vidéos": [
      {name: "3GP", ext: "3gp"},
      {name: "AVI", ext: "avi"},
      {name: "MOV", ext: "mov"},
      {name: "MP4", ext: "mp4"},
      {name: "MKV", ext: "mkv"},
      {name: "WebM", ext: "webm"},
      {name: "WMV", ext: "wmv"},
      {name: "ASF", ext: "asf"},
      {name: "DivX", ext: "divx"},
      {name: "MPEG", ext: "mpeg"},
      {name: "OGV", ext: "ogv"}
    ],
    "Web & Markup": [
      {name: "HTML+", ext: "html"},
      {name: "HTML", ext: "htm"},
      
      {name: "Wireless Markup Language", ext: "wml"},
      {name: "Wireless Markup Language (wap)", ext: "wap"},
      {name: "XML", ext: "xml"}
    ],
         "Code": [   
      {name: "Adobe PostScript", ext: "ps"},
      {name: "Basic source code", ext: "bas"},
      {name: "C/C++ source code", ext: "c"},
      {name: "C++ source code (cpp)", ext: "cpp"},
      {name: "C++ source code (cc)", ext: "cc"},
      {name: "C++ source code (cxx)", ext: "cxx"},
      {name: "C/C++ header (h)", ext: "h"},
      {name: "C++ header (hpp)", ext: "hpp"},
      {name: "C# source code", ext: "cs"},
      {name: "Java source code", ext: "java"},
      {name: "Perl source code", ext: "pl"},
      {name: "Python source code", ext: "py"}
    ],
       "Formats géographiques": [
      {name: "Google Earth", ext: "kml"},
      {name: "Google Earth (kmz)", ext: "kmz"},
      {name: "GPS eXchange Format", ext: "gpx"},
      {name: "Hancom Hanword", ext: "hwp"}
    ]

  };
  const searchInput = document.getElementById('searchInput');
  const searchForm = document.getElementById('searchForm');
  const searchSource = document.getElementById('searchSource');
  const radioButtons = document.querySelectorAll('input[name="searchEngine"]');
  const wikiToggleBtn = document.getElementById('wikiToggleBtn');
  const wikiContent = document.getElementById('wikiContent');
  const keepWikiOpenCheckbox = document.getElementById('keepWikiOpenCheckbox');
  const filetypesBtn = document.getElementById('filetypesBtn');
  const filetypesPopup = document.getElementById('filetypesPopup');
  const filetypeList = document.getElementById('filetypeList');
  const siteCheckbox = document.getElementById('siteCheckbox');
  // --- Fonction utilitaire pour afficher source de recherche (reste inchangée) ---
  const internationale_search = {
    'g:': { name: 'Google', url: 'https://www.google.com/search?q=' },
    'yt:': { name: 'YouTube', url: 'https://www.youtube.com/results?search_query=' },
    'brave:': { name: 'Brave Search', url: 'https://search.brave.com/search?q=' },
    'ddg:': { name: 'DuckDuckGo', url: 'https://duckduckgo.com/?q=' },
    'yadx:': { name: 'Yandex', url: 'https://yandex.com/search/?text=' },
    'bing:': { name: 'Bing', url: 'https://www.bing.com/search?q=' },
    'g100:': { name: 'Google 100 results', url: 'https://www.google.com/search?q=' },
    'g+:': { name: 'Google Advanced', url: 'https://www.google.com/advanced_search?q=' },
    'these-fr:': { name: 'Theses.fr', url: 'https://theses.fr/?q=' },
    'these2.0:': { name: 'These2.0', url: 'https://thesefmpm.vercel.app/search?page=1&search=' },
    'these-ma:': { name: 'Toubkal', url: 'https://toubkal.imist.ma/?query=' },
    'these-ma-gs:': { name: 'Toubkal Google Search', url: 'https://www.google.com/search?q=site:toubkal.imist.ma+' },
    'cismef-th:': { name: 'CISMeF Thèses', url: 'https://doccismef.chu-rouen.fr/dc/#env=thm&q=' },
    'gs:': { name: 'Google Scholar', url: 'https://scholar.google.com/scholar?q=' },
    'rgt:': { name: 'ResearchGate', url: 'https://www.researchgate.net/search/publication?q=' },
    'ndltd:': { name: 'NDLTD', url: 'http://search.ndltd.org/search.php?q=' },
    'pbmd:': { name: 'PubMed', url: 'https://pubmed.ncbi.nlm.nih.gov/?term=' },
    'cismef:': { name: 'CISMeF', url: 'https://doccismef.chu-rouen.fr/dc/#q=' },
    'cismef-edn:': { name: 'CISMeF EDN', url: 'https://doccismef.chu-rouen.fr/dc/#env=ecn&q=' },
    'cismef-bp:': { name: 'CISMeF Best Practices', url: 'https://doccismef.chu-rouen.fr/dc/#env=bp&q=' },
    'cismef-edu:': { name: 'CISMeF Education', url: 'https://doccismef.chu-rouen.fr/dc/#env=unf3s&q=' },
    'lissa:': { name: 'LISSA', url: 'https://www.lissa.fr/dc/#env=lissa&q=' },
    'hetop:': { name: 'HETOP', url: 'https://www.hetop.eu/hetop/fr/#q=' },
    'has:': { name: 'Haute Autorité de Santé', url: 'https://www.has-sante.fr/jcms/fc_2875171/fr/resultat-de-recherche?text=' },
    'openmd:': { name: 'OpenMD', url: 'https://openmd.com/search?q=' },
    'wolfram:': { name: 'Wolfram Alpha', url: 'https://www.wolframalpha.com/input?i=' },
    'gpt:': { name: 'ChatGPT', url: 'https://chat.openai.com/?q=' },
    'x.ai:': { name: 'Grok', url: 'https://www.x.ai/grok?q=' },
    'g.ai:': { name: 'Gemini', url: 'https://gemini.google.com/?q=' },
    'p.ai:': { name: 'Perplexity', url: 'https://www.perplexity.ai/search?q=' }
  };
  function updateSearchSource() {
    let source = "Entrez une requête pour afficher la source";
    let color = "#333";
    let prefix = "";
    let value = searchInput.value.trim();
    for (const [key, obj] of Object.entries(internationale_search)) {
      if (value.startsWith(key)) {
        source = "Source de recherche : " + obj.name;
        color = "green";
        prefix = key;
        // Sync radio
        document.querySelectorAll('input[name="searchEngine"]').forEach(radio => {
          radio.parentElement.classList.remove('selected');
          if (radio.value === key) {
            radio.checked = true;
            radio.parentElement.classList.add('selected');
          }
        });
        break;
      }
    }
    if (!prefix) {
      // Use selected radio
      const selected = document.querySelector('input[name="searchEngine"]:checked');
      if (selected && selected.value && internationale_search[selected.value]) {
        source = "Source de recherche : " + internationale_search[selected.value].name;
        color = "green";
        selected.parentElement.classList.add('selected');
      }
    }
    searchSource.textContent = source;
    searchSource.style.color = color;
  }
  searchInput.addEventListener('input', updateSearchSource);
  radioButtons.forEach(radio => {
    radio.addEventListener('change', function() {
      radioButtons.forEach(r => r.parentElement.classList.remove('selected'));
      radio.parentElement.classList.add('selected');
      let val = searchInput.value.trim();
      let selectedPrefix = radio.value;
      for (const key of Object.keys(internationale_search)) {
        if (val.startsWith(key)) {
          val = val.substring(key.length).trimStart();
          break;
        }
      }
      searchInput.value = selectedPrefix + (val ? ' ' + val : '');
      updateSearchSource();
    });
  });
  searchForm.addEventListener('submit', function(e) {
    e.preventDefault();
    let value = searchInput.value.trim();
    let prefix = '';
    let query = '';
    for (const key of Object.keys(internationale_search)) {
      if (value.startsWith(key)) {
        prefix = key;
        query = value.substring(prefix.length).trim();
        break;
      }
    }
    if (!prefix) {
      const selected = document.querySelector('input[name="searchEngine"]:checked');
      if (selected) prefix = selected.value;
      query = value;
    }

    if (siteCheckbox.checked) {
      // If site checkbox checked, override to Google site search restricted to selected radio's site
      const selectedRadio = document.querySelector('input[name="searchEngine"]:checked');
      if (selectedRadio && selectedRadio.value && internationale_search[selectedRadio.value]) {
        // Extract site URL domain from the selected search engine url
        let siteUrl = internationale_search[selectedRadio.value].url;
        try {
          // Use URL constructor to isolate hostname
          let urlObj = new URL(siteUrl);
          siteUrl = urlObj.hostname;
        } catch (err) {
          // Fallback parsing
          siteUrl = siteUrl.replace(/^https?:\/\//, '').split(/[/?#]/)[0];
        }
        // Construct Google search with site:domain + query
        const googleSearchUrl = 'https://www.google.com/search?q=';
        let googleQuery = encodeURIComponent(`site:${siteUrl} ${query}`);
        window.open(googleSearchUrl + googleQuery, '_blank');
        return; // exit early, already handled
      }
    }

    // Normal search behavior
    if (prefix && query) {
      let url = internationale_search[prefix].url + encodeURIComponent(query);
      if (prefix === 'g100:') url += '&num=100';
      window.open(url, '_blank');
    }
  });
  // Wiki toggle (inchangé)
  wikiToggleBtn.addEventListener('click', () => {
    if (wikiContent.style.display === 'block') {
      if (keepWikiOpenCheckbox.checked) {
        return;
      }
      wikiContent.style.display = 'none';
      wikiToggleBtn.setAttribute('aria-expanded', 'false');
    } else {
      wikiContent.style.display = 'block';
      wikiToggleBtn.setAttribute('aria-expanded', 'true');
      wikiContent.focus();
    }
  });
  // Focus auto au load
  window.addEventListener('load', () => {
    updateSearchSource();
    searchInput.focus();
  });
  // ----- Partie spécifique au bouton filetypes ------
  // Création dynamique de la liste filetypes dans le popup
  function renderFiletypesList() {
    filetypeList.innerHTML = ''; // Clear
    for (const [category, types] of Object.entries(filetypesWiki)) {
      const catLi = document.createElement('li');
      catLi.classList.add('category');
      catLi.textContent = category;
      filetypeList.appendChild(catLi);
      types.forEach(ft => {
        const itemLi = document.createElement('li');
        itemLi.classList.add('item');
        // Affichage : Nom (extension entre parenthèses)
        itemLi.textContent = `${ft.name} (${ft.ext})`;
        itemLi.setAttribute('data-ext', ft.ext);
        itemLi.tabIndex = 0; // pour accessibilité clavier
        // Au clic, on insère filetype:"ext" dans barre de recherche
        itemLi.addEventListener('click', () => {
          insertOrReplaceFiletype(ft.ext);
          fadeOutFiletypesPopup();
          searchInput.focus();
        });
        // Interaction clavier (Enter ou Espace)
        itemLi.addEventListener('keydown', e => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            itemLi.click();
          }
        });
        filetypeList.appendChild(itemLi);
      });
    }
  }
  // Affichage/caché du popup filetypes
  filetypesBtn.addEventListener('click', () => {
    if (filetypesPopup.style.display === 'block') {
      fadeOutFiletypesPopup();
    } else {
      renderFiletypesList();
      filetypesPopup.style.display = 'block';
      filetypesPopup.style.opacity = '1';
      filetypesBtn.setAttribute('aria-expanded', 'true');
      // Positionnement précis si besoin (ici fixed dans CSS)
      filetypesPopup.focus();
    }
  });
  // Fonction fade out
  function fadeOutFiletypesPopup() {
    filetypesPopup.style.opacity = '0';
    filetypesBtn.setAttribute('aria-expanded', 'false');
    setTimeout(() => {
      filetypesPopup.style.display = 'none';
    }, 600);
  }
  // Fonction pour insérer ou remplacer un filtre filetype:"xxx"
  function insertOrReplaceFiletype(ext) {
    let val = searchInput.value.trim();
    // Regex pour détecter un filtre filetype déjà existant (sans guillemets)
    const filetypeRegex = /filetype:([^\s]+)/i;
    if (filetypeRegex.test(val)) {
      // Remplacer l'ancien filetype
      val = val.replace(filetypeRegex, `filetype:${ext}`);
    } else {
      // Ajouter à la fin (avec espace si besoin)
      if (val.length > 0) val += ' ';
      val += `filetype:${ext}`;
    }
    searchInput.value = val;
    updateSearchSource();
  }
  // Pour fermeture popup si clic dehors
  document.addEventListener('click', (e) => {
    if (!filetypesPopup.contains(e.target) && e.target !== filetypesBtn) {
      if (filetypesPopup.style.display === 'block') {
        fadeOutFiletypesPopup();
      }
    }
    // Pour wikiContent aussi
    if (!wikiContent.contains(e.target) && e.target !== wikiToggleBtn) {
      if (wikiContent.style.display === 'block' && !keepWikiOpenCheckbox.checked) {
        wikiContent.style.display = 'none';
        wikiToggleBtn.setAttribute('aria-expanded', 'false');
      }
    }
  });
  // Fermeture popup filetypes avec Esc
  filetypesPopup.addEventListener('keydown', e => {
    if(e.key === 'Escape') {
      fadeOutFiletypesPopup();
      filetypesBtn.focus();
    }
  });
</script>
</body>
</html>
